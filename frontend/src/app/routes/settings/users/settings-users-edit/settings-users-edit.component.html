<ng-container *ngIf="editing">
  <h1>Editing {{ model.usernameValue }}</h1>
</ng-container>
<ng-container *ngIf="adding">
  <h1>Add new user</h1>
</ng-container>

<form (ngSubmit)="updateUser()">
  <div class="row">
    <div class="col-12 py-2" *ngIf="updateFail">
      <mat-error *ngIf="adding"> Failed to add user </mat-error>
      <mat-error *ngIf="editing"> Failed to update user </mat-error>
    </div>
  </div>

  <div class="row" *ngIf="adding">
    <div class="col-lg-6 col-12">
      <mat-form-field appearance="outline" color="accent">
        <mat-label>Username</mat-label>
        <input
          matInput
          type="text"
          [formControl]="model.username"
          name="username"
          autocorrect="off"
          autocapitalize="none"
          required
        />
        <mat-error *ngIf="model.username.errors">
          {{ model.usernameError }}
        </mat-error>
      </mat-form-field>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-6 col-12">
      <mat-form-field appearance="outline" color="accent">
        <mat-label>{{ editing ? "New Password" : "Password" }}</mat-label>
        <input
          matInput
          type="password"
          [formControl]="model.password"
          name="password"
          [required]="adding"
        />
        <mat-error *ngIf="model.password.errors">
          {{ model.passwordError }}
        </mat-error>
      </mat-form-field>
    </div>
  </div>

  <div class="row" *ngIf="!isLockedPerms()">
    <div class="col-lg-6 col-12">
      <mat-form-field appearance="outline" color="accent">
        <mat-label>Roles</mat-label>
        <mat-chip-list #chipList aria-label="Roles Selection">
          <mat-chip
            *ngFor="let role of model.selectedRoles"
            [removable]="model.isRemovable(role)"
            [disabled]="!model.isRemovable(role)"
            (removed)="removeRole(role)"
          >
            {{ role }}
            <button *ngIf="model.isRemovable(role)" matChipRemove>
              <mat-icon>cancel</mat-icon>
            </button>
          </mat-chip>
          <input
            placeholder="Add role..."
            #fruitInput
            [formControl]="model.rolesControl"
            [value]="model.rolesControl.value"
            [matAutocomplete]="auto"
            [matChipInputFor]="chipList"
            [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
            (matChipInputTokenEnd)="addRole($event)"
            autocorrect="off"
            autocapitalize="none"
          />
        </mat-chip-list>
        <mat-autocomplete
          #auto="matAutocomplete"
          (optionSelected)="selectedRole($event)"
        >
          <mat-option
            *ngFor="let role of model.selectableRoles | async"
            [value]="role"
          >
            {{ role }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <h3>Effective Permissions</h3>
    </div>
    <div class="col-12">
      <mat-chip-list aria-label="User Permissions">
        <mat-chip
          *ngFor="let permission of getEffectivePermissions()"
          [disableRipple]="true"
        >
          {{ permission }}
        </mat-chip>
      </mat-chip-list>
    </div>
  </div>

  <div class="row">
    <div class="col-12 py-4">
      <button mat-raised-button color="accent" type="submit">
        {{ editing ? "Update" : "Add" }}
      </button>

      <button
        mat-raised-button
        class="ms-2"
        color="primary"
        type="button"
        (click)="cancel()"
      >
        Cancel
      </button>
    </div>
  </div>
</form>
